<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Stable DEX</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<style>
:root{
  --bg1:#ecfdf5; --bg2:#d1fae5;
  --card:#ffffff; --mut:#e9f7ef;
  --text:#052e2b; --sub:#335f58;
  --g1:#22c55e; --g2:#16a34a; /* gradient */
  --line:#dff3e7;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family:Poppins,system-ui,Arial;
  background:linear-gradient(180deg,var(--bg1),var(--bg2));
  color:var(--text);
}
.header{
  max-width:1000px; margin:0 auto; padding:16px 18px;
  display:flex; align-items:center; justify-content:space-between;
}
.brand{display:flex; gap:10px; align-items:center; font-weight:700}
.brand svg{width:28px; height:28px}
.brand span{font-size:18px}
.connect{
  border:0; padding:10px 14px; border-radius:12px; color:#fff; font-weight:700;
  background:linear-gradient(90deg,var(--g1),var(--g2)); cursor:pointer;
}
.wrap{
  max-width:1000px; margin:24px auto; padding:0 18px;
  display:grid; place-items:center;
}
.card{
  width:min(480px, 96vw); background:var(--card); border-radius:20px;
  box-shadow:0 14px 40px rgba(16,185,129,.18);
  border:1px solid var(--line);
  padding:18px;
}
.tabs{display:flex; gap:6px; background:var(--mut); padding:6px; border-radius:12px; margin-bottom:12px}
.tab{
  flex:1; text-align:center; padding:10px 0; border-radius:10px; cursor:pointer; user-select:none;
  font-weight:700; color:var(--sub);
}
.tab.active{
  background:#fff; color:var(--text); border:1px solid var(--line);
}
.panel{display:none}
.panel.active{display:block}

.swap-card{
  display:flex; flex-direction:column; gap:10px;
}
.row{
  background:#f6fdf9; border:1px solid var(--line); border-radius:14px; padding:12px;
}
.row-top{display:flex; justify-content:space-between; align-items:center; margin-bottom:8px}
.token{
  display:flex; gap:8px; align-items:center;
  background:#fff; border:1px solid var(--line); padding:8px 10px; border-radius:12px; min-width:140px;
}
.token select{border:0; outline:0; background:transparent; font-weight:700}
.amt input{
  width:100%; border:0; outline:0; background:transparent;
  font-size:20px; font-weight:700; text-align:right;
}
.cta{
  width:100%; border:0; padding:14px; color:#fff; font-weight:800; border-radius:14px;
  background:linear-gradient(90deg,var(--g1),var(--g2)); cursor:pointer; margin-top:8px;
}
.mini{font-size:12px; color:var(--sub); margin-top:6px}
.kv{display:flex; justify-content:space-between; font-size:12px; color:var(--sub)}
.divider{height:1px; background:var(--line); margin:10px 0}

.input{
  width:100%; border:1px solid var(--line); border-radius:12px; padding:10px; background:#f6fdf9;
}
.two{display:grid; grid-template-columns:1fr 1fr; gap:8px}

pre{
  background:#f1fbf5; border:1px solid var(--line); color:#0b3b35;
  padding:12px; border-radius:12px; white-space:pre-wrap; font-size:12px; margin-top:12px; max-height:220px; overflow:auto;
}
footer{max-width:1000px; margin:12px auto 24px; text-align:center; color:#588b83; font-size:12px}
</style>
</head>
<body>
  <header class="header">
    <div class="brand">
      <!-- Logo SVG Stable vibe -->
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" aria-hidden="true">
        <circle cx="32" cy="32" r="30" fill="#10b981"/>
        <path fill="#fff" d="M20 32a12 12 0 0 1 24 0a12 12 0 0 1-24 0zm12-20a20 20 0 1 0 0 40a20 20 0 1 0 0-40z"/>
      </svg>
      <span>Stable DEX</span>
    </div>
    <button id="btnConnect" class="connect">Connect Wallet</button>
  </header>

  <main class="wrap">
    <section class="card">
      <div class="tabs">
        <div id="tabSwap" class="tab active">Swap</div>
        <div id="tabLiq" class="tab">Liquidity</div>
      </div>

      <!-- SWAP PANEL -->
      <div id="panelSwap" class="panel active">
        <div class="swap-card">
          <div class="row">
            <div class="row-top">
              <div class="token">
                <select id="fromToken"></select>
              </div>
              <div class="amt"><input id="fromAmount" type="number" placeholder="0.0" /></div>
            </div>
            <div class="kv"><span>Balance:</span><span id="balFrom">-</span></div>
          </div>

          <div class="row">
            <div class="row-top">
              <div class="token">
                <select id="toToken"></select>
              </div>
              <div class="amt"><input id="toAmount" type="number" placeholder="0.0" /></div>
            </div>
            <div class="kv"><span>Balance:</span><span id="balTo">-</span></div>
          </div>

          <button id="btnSwap" class="cta">Swap</button>
          <div class="mini" id="priceBox">Price: -</div>
        </div>
      </div>

      <!-- LIQUIDITY PANEL -->
      <div id="panelLiq" class="panel">
        <div class="two">
          <div>
            <div class="mini">Base (gUSDT)</div>
            <input id="liqBase" class="input" type="number" placeholder="0.0" />
          </div>
          <div>
            <div class="mini">Quote</div>
            <input id="liqQuote" class="input" type="number" placeholder="0.0" />
          </div>
        </div>
        <div class="two" style="margin-top:8px">
          <button id="btnAdd" class="cta">Add Liquidity</button>
          <button id="btnRemove" class="cta">Remove Liquidity</button>
        </div>
        <div class="divider"></div>
        <div class="kv"><span>Reserves</span><span id="reservesBox">-</span></div>
        <div class="kv"><span>LP Balance</span><span id="lpBox">-</span></div>
      </div>

      <pre id="log">log siap...</pre>
    </section>
  </main>

  <footer>by thdx</footer>

<script>
/* =========================
   EDIT HERE â€” Addresses
   ========================= */
const STABLE = { id: 2201, hex: "0x899", rpc: "https://stable-jsonrpc.testnet.chain0.dev" };

/* Token hardcoded (ganti jika berbeda di jaringanmu) */
const TOKENS = {
  gUSDT:  { symbol:"gUSDT", addr:"0x701f3927871EfcEa1235dB722f9E608aE120d243", decimals:6 },
  USDT0:  { symbol:"USDT0", addr:"0x78cf24370174180738c5b8e352b6d14c83a6c9a9", decimals:6 },
  USDC:   { symbol:"USDC",  addr:"0x1c7D4B196Cb0C7B01d743Fbc6116a902379C7238", decimals:6 },
  DAI:    { symbol:"DAI",   addr:"0x0000000000000000000000000000000000000dAi", decimals:18 }, // mock
  WBTC:   { symbol:"WBTC",  addr:"0x000000000000000000000000000000000000wBtC", decimals:8  }, // mock
  MOCKETH:{ symbol:"ETH",   addr:"0x000000000000000000000000000000000000eTh", decimals:18 }  // mock ERC20
};

/* AMM/Router address (HARDCODED) â€” implementasi Tokenâ†”Token (base gUSDT vs Quote) */
const AMM = {
  addr: "0xcAB8F3ed8528655E0C2fad1C504c6CfEccf50B90" // ganti kalau kamu punya router/AMM sendiri
};

/* ABIs â€” asumsi AMM Token-Token (base=gUSDT, quote=ERC20) */
const TT_AMM_ABI = [
  "function base() view returns (address)",
  "function quote() view returns (address)",
  "function getPair(address _base, address _quote) view returns (uint256 baseRes, uint256 quoteRes)", // optional; fallback to global reserves if not exists
  "function getReserves() view returns (uint256 baseRes, uint256 quoteRes)",
  "function totalSupplyLP() view returns (uint256)",
  "function balanceOfLP(address) view returns (uint256)",
  "function addLiquidity(address _base, address _quote, uint256 baseAmt, uint256 quoteAmt)",
  "function removeLiquidity(address _base, address _quote, uint256 lpAmt) returns (uint256 baseOut, uint256 quoteOut)",
  "function swapExactBaseForQuote(address _base, address _quote, uint256 baseIn, uint256 minQuoteOut)",
  "function swapExactQuoteForBase(address _base, address _quote, uint256 quoteIn, uint256 minBaseOut)"
];

const ERC20_ABI = [
  "function decimals() view returns (uint8)",
  "function balanceOf(address) view returns (uint256)",
  "function allowance(address,address) view returns (uint256)",
  "function approve(address,uint256) returns (bool)"
];

/* =========================
   State & Utils
   ========================= */
const $ = id => document.getElementById(id);
const log = m => { const el=$("log"); el.textContent += (el.textContent? "\n":"") + m; el.scrollTop = el.scrollHeight; console.log(m); };

let provider, signer, me;

async function ensureStable() {
  const net = await provider.getNetwork();
  if (Number(net.chainId) === STABLE.id) return;
  try {
    await window.ethereum.request({ method:"wallet_switchEthereumChain", params:[{ chainId: STABLE.hex }] });
  } catch(e){
    if (e.code === 4902) {
      await window.ethereum.request({
        method: "wallet_addEthereumChain",
        params: [{
          chainId: STABLE.hex, chainName:"Stable Testnet",
          rpcUrls:[STABLE.rpc], nativeCurrency:{ name:"ETH", symbol:"ETH", decimals:18 },
          blockExplorerUrls:["https://blockscout.testnet.stable.xyz"]
        }]
      });
    } else { throw e; }
  }
}

function fillTokenSelects(){
  const entries = Object.values(TOKENS);
  for (const selId of ["fromToken","toToken"]) {
    const sel = $(selId); sel.innerHTML = "";
    entries.forEach(t=>{
      const o = document.createElement("option");
      o.value = t.symbol; o.textContent = t.symbol;
      sel.appendChild(o);
    });
  }
  // default: gUSDT -> USDT0
  $("fromToken").value = "gUSDT";
  $("toToken").value = "USDT0";
}

function getTokenInfo(sym){ return TOKENS[sym]; }
function parseU(val,dec){ return ethers.utils.parseUnits(String(val||"0"), dec); }
function fmtU(bn,dec){ return ethers.utils.formatUnits(bn, dec); }

async function connect(){
  try{
    if(!window.ethereum) throw new Error("MetaMask/OKX/Trust belum aktif.");
    provider = new ethers.providers.Web3Provider(window.ethereum,"any");
    await provider.send("eth_requestAccounts",[]);
    signer = provider.getSigner();
    me = await signer.getAddress();
    await ensureStable();
    const n = await provider.getNetwork();
    $("btnConnect").textContent = me.slice(0,6)+"â€¦"+me.slice(-4);
    log(`âœ… Connected: ${me}\nChain: ${n.chainId}`);
    await refreshBalances();
    await refreshReserves();
  }catch(e){ log("âŒ Connect error: "+(e.message||e)); }
}

async function refreshBalances(){
  try{
    const f = getTokenInfo($("fromToken").value);
    const t = getTokenInfo($("toToken").value);
    const bf = await new ethers.Contract(f.addr, ERC20_ABI, provider).balanceOf(me);
    const bt = await new ethers.Contract(t.addr, ERC20_ABI, provider).balanceOf(me);
    $("balFrom").textContent = fmtU(bf, f.decimals);
    $("balTo").textContent   = fmtU(bt, t.decimals);
  }catch(e){ $("balFrom").textContent="-"; $("balTo").textContent="-"; }
}

async function refreshReserves(){
  try{
    const c = new ethers.Contract(AMM.addr, TT_AMM_ABI, provider);
    const b = getTokenInfo("gUSDT").addr;
    const q = getTokenInfo($("toToken").value).addr;
    let baseRes, quoteRes;
    try {
      const r = await c.getPair(b, q);
      baseRes = r.baseRes || r[0]; quoteRes = r.quoteRes || r[1];
    } catch {
      const r = await c.getReserves();
      baseRes = r.baseRes || r[0]; quoteRes = r.quoteRes || r[1];
    }
    const bDec = getTokenInfo("gUSDT").decimals;
    const qDec = getTokenInfo($("toToken").value).decimals;
    $("reservesBox").textContent = `gUSDT ${fmtU(baseRes,bDec)} | ${$("toToken").value} ${fmtU(quoteRes,qDec)}`;
    // naive price
    const p = Number(fmtU(quoteRes,qDec)) / Math.max(Number(fmtU(baseRes,bDec)), 1e-12);
    $("priceBox").textContent = `Price: 1 gUSDT â‰ˆ ${isFinite(p)?p.toFixed(6):'-'} ${$("toToken").value}`;
  }catch(e){ $("reservesBox").textContent="-"; $("priceBox").textContent="Price: -"; }
}

async function ensureApprove(tokenAddr, spender, amount){
  const erc = new ethers.Contract(tokenAddr, ERC20_ABI, signer);
  const allow = await erc.allowance(me, spender);
  if (allow.gte(amount)) return;
  const tx = await erc.approve(spender, amount);
  log(`ðŸ§¾ Approve: ${tx.hash}`);
  await tx.wait();
  log("âœ… Approve sukses");
}

/* =========================
   SWAP
   ========================= */
async function onSwap(){
  try{
    const fromSym = $("fromToken").value;
    const toSym   = $("toToken").value;
    if (fromSym === toSym) return alert("Pilih token berbeda.");

    const from = getTokenInfo(fromSym);
    const to   = getTokenInfo(toSym);
    const amt  = $("fromAmount").value.trim();
    if(!amt) return alert("Isi jumlah swap.");

    const base = getTokenInfo("gUSDT");
    const amm  = new ethers.Contract(AMM.addr, TT_AMM_ABI, signer);

    // Arahkan fungsi berdasarkan arah
    if (fromSym === "gUSDT") {
      // swapExactBaseForQuote(baseIn, minQuoteOut)
      const inAmt  = parseU(amt, base.decimals);
      await ensureApprove(base.addr, AMM.addr, inAmt);
      const minOut = ethers.BigNumber.from(0);
      log("ðŸ”„ Swap gUSDT â†’ "+to.symbol+"...");
      const tx = await amm.swapExactBaseForQuote(base.addr, to.addr, inAmt, minOut);
      log("â³ TX: "+tx.hash); await tx.wait();
      log("âœ… Swap sukses!");
    } else if (toSym === "gUSDT") {
      // swapExactQuoteForBase(quoteIn, minBaseOut)
      const inAmt  = parseU(amt, from.decimals);
      await ensureApprove(from.addr, AMM.addr, inAmt);
      const minOut = ethers.BigNumber.from(0);
      log("ðŸ” Swap "+from.symbol+" â†’ gUSDT...");
      const tx = await amm.swapExactQuoteForBase(base.addr, from.addr, inAmt, minOut);
      log("â³ TX: "+tx.hash); await tx.wait();
      log("âœ… Swap sukses!");
    } else {
      // indirect: QuoteA -> gUSDT -> QuoteB (2 leg) â€” untuk v3 ini kita tolak agar simple
      return alert("Pair non-gUSDT belum diaktifkan. Pilih salah satu sisi gUSDT.");
    }

    await refreshBalances();
    await refreshReserves();
  }catch(e){ log("âŒ Swap error: "+(e.reason||e.message||e)); }
}

/* =========================
   LIQUIDITY
   ========================= */
async function onAddLiq(){
  try{
    const base = getTokenInfo("gUSDT");
    const quote = getTokenInfo($("toToken").value); // quote dari pilihan "to"
    const baseAmtH = $("liqBase").value.trim();
    const quoteAmtH= $("liqQuote").value.trim();
    if(!baseAmtH || !quoteAmtH) return alert("Isi jumlah Base & Quote.");

    const amm = new ethers.Contract(AMM.addr, TT_AMM_ABI, signer);
    const baseAmt  = parseU(baseAmtH,  base.decimals);
    const quoteAmt = parseU(quoteAmtH, quote.decimals);

    await ensureApprove(base.addr,  AMM.addr, baseAmt);
    await ensureApprove(quote.addr, AMM.addr, quoteAmt);

    log("ðŸ’§ Add Liquidity gUSDT / "+quote.symbol+"...");
    const tx = await amm.addLiquidity(base.addr, quote.addr, baseAmt, quoteAmt);
    log("â³ TX: "+tx.hash); await tx.wait();
    log("âœ… Liquidity added");
    await refreshReserves();
  }catch(e){ log("âŒ Add error: "+(e.reason||e.message||e)); }
}

async function onRemoveLiq(){
  try{
    const base = getTokenInfo("gUSDT");
    const quote= getTokenInfo($("toToken").value);
    const lpAmtH = $("liqBase").value.trim(); // gunakan field kiri sebagai LP amt agar simple
    if(!lpAmtH) return alert("Isi nilai LP yang mau diburn (dalam 18 desimal, ex: 0.1).");

    const amm = new ethers.Contract(AMM.addr, TT_AMM_ABI, signer);
    const lpAmt = ethers.utils.parseUnits(lpAmtH, 18);

    log("ðŸ§¹ Remove LP...");
    const tx = await amm.removeLiquidity(base.addr, quote.addr, lpAmt);
    log("â³ TX: "+tx.hash); await tx.wait();
    log("âœ… Remove liquidity done");
    await refreshReserves();
  }catch(e){ log("âŒ Remove error: "+(e.reason||e.message||e)); }
}

/* =========================
   UI Bindings
   ========================= */
$("btnConnect").onclick = connect;
$("btnSwap").onclick    = onSwap;
$("btnAdd").onclick     = onAddLiq;
$("btnRemove").onclick  = onRemoveLiq;

$("fromToken").onchange = ()=>{ refreshBalances(); };
$("toToken").onchange   = ()=>{ refreshBalances(); refreshReserves(); };
$("fromAmount").oninput = ()=>{ /* optional: calc quote preview */ };

$("tabSwap").onclick = ()=>{ 
  $("tabSwap").classList.add("active");
  $("tabLiq").classList.remove("active");
  $("panelSwap").classList.add("active");
  $("panelLiq").classList.remove("active");
};
$("tabLiq").onclick = ()=>{ 
  $("tabLiq").classList.add("active");
  $("tabSwap").classList.remove("active");
  $("panelLiq").classList.add("active");
  $("panelSwap").classList.remove("active");
};

/* Init */
fillTokenSelects();
</script>
</body>
</html>
